#!/bin/bash
# GitPeek Pre-commit Hook
# TDDã¨ã‚³ãƒ¼ãƒ‰å“è³ªã‚’ä¿è¨¼

set -e

echo "ğŸ” Running pre-commit checks..."

# SwiftLintãƒã‚§ãƒƒã‚¯
if which swiftlint >/dev/null; then
    echo "ğŸ“ Checking SwiftLint..."
    swiftlint --quiet
    if [ $? -ne 0 ]; then
        echo "âŒ SwiftLint failed. Please fix warnings before committing."
        echo "Run 'make lint-fix' to auto-fix some issues."
        exit 1
    fi
    echo "âœ… SwiftLint passed"
else
    echo "âš ï¸ SwiftLint not installed. Run 'make setup' to install."
fi

# SwiftFormatãƒã‚§ãƒƒã‚¯
if which swiftformat >/dev/null; then
    echo "ğŸ¨ Checking SwiftFormat..."
    swiftformat --lint . --quiet
    if [ $? -ne 0 ]; then
        echo "âŒ SwiftFormat check failed."
        echo "Run 'make format' to auto-format."
        exit 1
    fi
    echo "âœ… SwiftFormat passed"
else
    echo "âš ï¸ SwiftFormat not installed. Run 'make setup' to install."
fi

# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆé«˜é€Ÿãªå˜ä½“ãƒ†ã‚¹ãƒˆã®ã¿ï¼‰
echo "ğŸ§ª Running unit tests..."
if xcodebuild test -scheme GitPeek -destination 'platform=macOS' -only-testing:GitPeekTests/Unit -quiet 2>/dev/null; then
    echo "âœ… Unit tests passed"
else
    echo "âŒ Unit tests failed. Please fix before committing."
    echo "Remember: TDD - Red, Green, Refactor!"
    exit 1
fi

# Force unwrapãƒã‚§ãƒƒã‚¯
echo "ğŸ” Checking for force unwraps..."
FORCE_UNWRAPS=$(grep -r "!" --include="*.swift" GitPeek | grep -v "// swiftlint:disable" | grep -v "fatalError" || true)
if [ ! -z "$FORCE_UNWRAPS" ]; then
    echo "âš ï¸ Warning: Force unwraps detected. Consider using guard or if-let instead."
fi

# TODOãƒã‚§ãƒƒã‚¯
TODOS=$(grep -r "TODO\|FIXME" --include="*.swift" GitPeek GitPeekTests || true)
if [ ! -z "$TODOS" ]; then
    echo "ğŸ“ Reminder: You have TODOs in your code:"
    echo "$TODOS"
fi

echo "âœ… All pre-commit checks passed!"
echo "ğŸš€ Ready to commit!"